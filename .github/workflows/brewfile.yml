name: Brewfile Check

on:
  push:
    branches: [main]
    paths:
      - "Brewfile"
  pull_request:
    branches: [main]
    paths:
      - "Brewfile"
  schedule:
    - cron: "0 0 * * 1" # 毎週月曜日に実行
  workflow_dispatch:

jobs:
  validate:
    name: Validate Brewfile
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Update Homebrew
        run: brew update

      - name: Check package availability
        shell: bash
        run: |
          echo "## Brewfile Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          error_file=$(mktemp)
          echo "0" > "$error_file"

          add_error() {
            count=$(cat "$error_file")
            echo $((count + 1)) > "$error_file"
          }

          # Check taps
          echo "### Taps" >> "$GITHUB_STEP_SUMMARY"
          while read -r line; do
            tap_name=$(echo "$line" | sed 's/tap "\([^"]*\)".*/\1/')
            if brew tap-info "$tap_name" &>/dev/null; then
              echo "- ✅ $tap_name" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "- ❌ $tap_name (not found)" >> "$GITHUB_STEP_SUMMARY"
              add_error
            fi
          done < <(grep -E "^tap " Brewfile || true)

          # Check brew packages
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Formulae (brew)" >> "$GITHUB_STEP_SUMMARY"
          while read -r line; do
            pkg=$(echo "$line" | sed 's/brew "\([^"]*\)".*/\1/')
            if brew info "$pkg" &>/dev/null; then
              echo "- ✅ $pkg" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "- ❌ $pkg (not found)" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Formula not found: $pkg"
              add_error
            fi
          done < <(grep -E "^brew " Brewfile || true)

          # Check casks
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Casks" >> "$GITHUB_STEP_SUMMARY"
          while read -r line; do
            cask=$(echo "$line" | sed 's/cask "\([^"]*\)".*/\1/')
            if brew info --cask "$cask" &>/dev/null; then
              echo "- ✅ $cask" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "- ❌ $cask (not found)" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Cask not found: $cask"
              add_error
            fi
          done < <(grep -E "^cask " Brewfile || true)

          # Exit with error if any packages not found
          errors=$(cat "$error_file")
          rm -f "$error_file"
          if [ "$errors" -gt 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**$errors package(s) not found in Homebrew**" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
