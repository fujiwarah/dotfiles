name: Brewfile Check

on:
  push:
    branches: [main]
    paths:
      - "Brewfile"
  pull_request:
    branches: [main]
    paths:
      - "Brewfile"
  schedule:
    - cron: "0 0 * * 1" # 毎週月曜日に実行
  workflow_dispatch:

jobs:
  validate:
    name: Validate Brewfile
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Update Homebrew
        run: brew update

      - name: Check package availability
        id: check
        shell: bash
        run: |
          echo "## Brewfile Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          removed_file=$(mktemp)
          touch "$removed_file"

          # Check taps
          echo "### Taps" >> "$GITHUB_STEP_SUMMARY"
          while read -r line; do
            tap_name=$(echo "$line" | sed 's/tap "\([^"]*\)".*/\1/')
            if brew tap-info "$tap_name" &>/dev/null; then
              echo "- ✅ $tap_name" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "- ❌ $tap_name (not found)" >> "$GITHUB_STEP_SUMMARY"
              echo "tap:$tap_name" >> "$removed_file"
            fi
          done < <(grep -E "^tap " Brewfile || true)

          # Check brew packages
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Formulae (brew)" >> "$GITHUB_STEP_SUMMARY"
          while read -r line; do
            pkg=$(echo "$line" | sed 's/brew "\([^"]*\)".*/\1/')
            if brew info "$pkg" &>/dev/null; then
              echo "- ✅ $pkg" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "- ❌ $pkg (not found)" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Formula not found: $pkg"
              echo "brew:$pkg" >> "$removed_file"
            fi
          done < <(grep -E "^brew " Brewfile || true)

          # Check casks
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Casks" >> "$GITHUB_STEP_SUMMARY"
          while read -r line; do
            cask=$(echo "$line" | sed 's/cask "\([^"]*\)".*/\1/')
            if brew info --cask "$cask" &>/dev/null; then
              echo "- ✅ $cask" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "- ❌ $cask (not found)" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Cask not found: $cask"
              echo "cask:$cask" >> "$removed_file"
            fi
          done < <(grep -E "^cask " Brewfile || true)

          # Count errors and set outputs
          errors=$(wc -l < "$removed_file" | tr -d ' ')
          echo "errors=$errors" >> "$GITHUB_OUTPUT"

          if [ "$errors" -gt 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**$errors package(s) not found in Homebrew**" >> "$GITHUB_STEP_SUMMARY"

            # Save removed packages for next step
            {
              echo 'removed<<EOF'
              cat "$removed_file"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

          rm -f "$removed_file"

      - name: Remove unavailable packages from Brewfile
        if: steps.check.outputs.errors > 0 && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        shell: bash
        run: |
          echo "${{ steps.check.outputs.removed }}" | while read -r line; do
            [ -z "$line" ] && continue
            type=$(echo "$line" | cut -d: -f1)
            name=$(echo "$line" | cut -d: -f2)
            echo "Removing $type: $name"
            case "$type" in
              tap)
                sed -i '' "/^tap \"$name\"/d" Brewfile
                ;;
              brew)
                # Escape special characters for sed
                escaped_name=$(echo "$name" | sed 's/[/@]/\\&/g')
                sed -i '' "/^brew \"$escaped_name\"/d" Brewfile
                ;;
              cask)
                escaped_name=$(echo "$name" | sed 's/[@]/\\&/g')
                sed -i '' "/^cask \"$escaped_name\"/d" Brewfile
                ;;
            esac
          done

      - name: Create Pull Request
        if: steps.check.outputs.errors > 0 && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: remove unavailable Homebrew packages"
          title: "chore: remove unavailable Homebrew packages"
          body: |
            ## Summary

            The following packages are no longer available in Homebrew and have been removed from the Brewfile:

            ```
            ${{ steps.check.outputs.removed }}
            ```

            This PR was automatically created by the Brewfile validation workflow.
          branch: chore/remove-unavailable-packages
          delete-branch: true
          reviewers: fujiwarah
          labels: unavailable brew package found

      - name: Fail on validation errors (push/PR only)
        if: steps.check.outputs.errors > 0 && github.event_name != 'schedule' && github.event_name != 'workflow_dispatch'
        run: exit 1
