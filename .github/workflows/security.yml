name: Security

on:
  push:
    branches: [main]
    paths:
      - "Brewfile"
  pull_request:
    branches: [main]
    paths:
      - "Brewfile"
  schedule:
    - cron: "0 0 * * 1" # 毎週月曜日に実行
  workflow_dispatch:

jobs:
  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install packages from Brewfile
        run: |
          # caskはCI環境ではスキップ（GUIアプリのため）
          grep -E "^brew " Brewfile | while read -r line; do
            pkg=$(echo "$line" | sed 's/brew "\([^"]*\)".*/\1/')
            echo "Installing $pkg..."
            brew install "$pkg" || echo "Failed to install $pkg, continuing..."
          done

      - name: Install Trivy
        run: brew install trivy

      - name: Scan Homebrew packages
        run: |
          echo "=== Scanning Homebrew Cellar ==="
          # macos-latest (macos-14) uses Apple Silicon, so /opt/homebrew
          CELLAR_PATH="/opt/homebrew/Cellar"
          if [ -d "/usr/local/Cellar" ]; then
            CELLAR_PATH="/usr/local/Cellar"
          fi

          trivy fs \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --format table \
            "$CELLAR_PATH"

      - name: Summary
        if: always()
        run: |
          echo "## Trivy Scan Results" >> "$GITHUB_STEP_SUMMARY"
          echo "Scanned Homebrew packages from Brewfile" >> "$GITHUB_STEP_SUMMARY"
